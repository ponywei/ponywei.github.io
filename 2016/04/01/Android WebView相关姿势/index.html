<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android WebView相关姿势 · HelloPony</title><meta name="description" content="Android WebView相关姿势 - PONY WEI"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/bigsmalleye.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/bigsmalleye.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ponywei" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android WebView相关姿势</h1><div class="post-time">2016年4月1日</div><div class="post-content"><p>在Android项目开发中，WebView的使用都是必不可少的。在一个基本功能完备的项目中，都会把WebView提取成一个公用的Activity组件，在需要跳转到H5页面的地方启动这个activity并传入相关参数即可。这样的简便快捷的使用，却容易造成开发者对WebView相关知识的疏忽。遂成此文，整理一二。</p>
<a id="more"></a>
<h2 id="添加WebView">添加WebView</h2><p>在应用中使用WebView，只需要在layout文件中添加</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;WebView</span><br><span class="line">    android:<span class="property">id</span>=<span class="string">"@+id/main_web_view"</span></span><br><span class="line">    android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">    android:layout_height=<span class="string">"match_parent"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>使用loadUrl方法来加载WebView</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WebView webView = (WebView) findViewById(R.<span class="property">id</span>.main_web_view);</span><br><span class="line">webView.loadUrl(<span class="string">"http://www.example.com"</span>);</span><br></pre></td></tr></table></figure>
<p>在此之前，还要确保应用有Internet权限</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:<span class="property">name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>至此，一个基本的WebView页就完成了。</p>
<h2 id="在WebView中使用JavaScript">在WebView中使用JavaScript</h2><p>默认情况下，WebView是禁用JavaScript的。通过如下代码来为WebView开启JavaScript支持</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WebSettings webSettings = webView.getSettings()<span class="comment">;</span></span><br><span class="line">webSettings.setJavaScriptEnabled(true)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>WebSettings管理着很多很有用的WebView设置项，例如setUserAgentString()等。具体细节可戳  <a href="http://androiddoc.qiniudn.com/reference/android/webkit/WebSettings.html" target="_blank" rel="external">WebSettings Doc</a>.</p>
<h3 id="WebView与JavaScript的交互*">WebView与JavaScript的交互*</h3><p>WebView属Android端，所以该交互问题就是Android本地与JS端的交互问题。为了便于梳理，写了如图所示的一个Demo <a href="https://github.com/ponywei/WebViewJSDemo" target="_blank" rel="external">Source code</a>，上半部分白底为WebView，加载本地的一个html页面，内含一个button和一个h1；下半部分是Android上的一个Button。 </p>
<p><img src="http://7u2h4k.com1.z0.glb.clouddn.com/2016-03-31%2017.55.55.png" alt="屏幕截图"></p>
<h3 id="WebView调用JavaScript的方法">WebView调用JavaScript的方法</h3><p>WebView调用JavaScript的方法相对比较简单，如果是无参数方法：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.<span class="function"><span class="title">loadUrl</span><span class="params">(<span class="string">"javascript:METHOD"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>其中 METHOD 为javascript方法名；<br>如果方法需要入参，例如下面这个javascript方法：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testMethod</span><span class="params">(name)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于javascript为弱类型语言，所以入参并没有指定任何类型；具体类型的处理一般在javascript方法体内。<br>在webView中调用方法（注意，如果是字符串类型，必须在用单引号包裹，否则javascript无法识别，会提示name为定义）：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String <span class="property">name</span> = <span class="string">"Android"</span>;</span><br><span class="line">webView.loadUrl(<span class="string">"javascript:testMethod('"</span> + <span class="property">name</span> + <span class="string">"')"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="JavaScript调用Android端的Java方法">JavaScript调用Android端的Java方法</h3><h4 id="1-创建接口">1.创建接口</h4><p>想要在 JavaScript 中调用相关的 Java 方法，需要在JavaScript端与Android客户端之间建立一个接口。</p>
<p>如下名为WebAppInterface的类，该类提供了一个名为showToast的本地方法，调用Android Toast通知消息，需要入参；该方法为等待JavaScript调用的方法，必须指定为 public 。</p>
<p>注意：如果 targetSdkVersion &gt;= 17 ;必须要在为JS设置的方法加上 <strong> @JavascriptInterface </strong> 的注解；如果没有该注解，那么该方法在Android 4.2及以上的系统中是无法被JS访问到的。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebAppInterface</span> &#123;</span><br><span class="line">		Context mContext;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** Instantiate the interface and set the context */</span></span><br><span class="line">		WebAppInterface(Context c) &#123;</span><br><span class="line">			mContext = c;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** Show a toast from the web page */</span></span><br><span class="line">		@<span class="function">JavascriptInterface</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span>(<span class="params">String toast</span>) </span>&#123;</span><br><span class="line">			Toast.makeText(mContext, <span class="string">"Hello,"</span> + toast, Toast.LENGTH_SHORT).show();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-绑定接口">2.绑定接口</h4><p>将该接口绑定到javascript，并指定一个名字，用于在javascript中调用。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> WebAppInterface(<span class="keyword">this</span>), <span class="string">"Android"</span>);</span><br></pre></td></tr></table></figure>
<p>这样就为运行在WebView中的JavaScript创建了一个名为Android的接口，</p>
<h4 id="3-调用">3.调用</h4><p>在javascript中的调用方法如下代码所示，id为btnCallNative的button在点击时后调用名为showAndroidToast的JS方法，并传入参数字符串；showAndroidToast方法体中通过名为Android的接口调用Android端的showToast方法，同时传入参数（注意： <strong> 没有必要 </strong> 再在javascript中对 “Android”  进行初始化，步骤2中webView已自动完成此工作）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="actionscript"></span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">showAndroidToast</span><span class="params">(toast)</span></span>&#123;</span><br><span class="line">           Android.showToast(toast);</span><br><span class="line">       &#125;</span><br><span class="line">   </span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">button</span> <span class="attribute">id</span>=<span class="value">"btnCallNative"</span> <span class="attribute">onclick</span> = "<span class="attribute">showAndroidToast</span>('<span class="attribute">javascript</span>')"&gt;</span>JS call Native<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="WebView页面导航处理">WebView页面导航处理</h2><p>当你在WebView中点击其他链接时，系统默认会去启动一个默认浏览器（或弹出选择）去处理这个URL请求。大多数情况下这都不符合需求场景，我们可以通过创建自定义的 <strong> WebViewClient </strong> 来修改这个规则，让用户的前进或者后退操作都在这个WebView内进行，或者打开其他程序来处理。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebViewClient</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">WebViewClient</span> &#123;</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public boolean shouldOverrideUrlLoading(<span class="type">WebView</span> view, <span class="type">String</span> url) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">Uri</span>.parse(url).getHost().equals(<span class="string">"www.example.com"</span>)) &#123;</span><br><span class="line">            <span class="comment">// This is my web site, so do not override; let my WebView load the page</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Otherwise, the link is not for a page on my site, so launch another Activity that handles URLs</span></span><br><span class="line">        <span class="type">Intent</span> intent = <span class="keyword">new</span> <span class="type">Intent</span>(<span class="type">Intent</span>.<span class="type">ACTION_VIEW</span>, <span class="type">Uri</span>.parse(url));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码定义了一个名为MyWebViewClient的类，继承字WebViewClient，通过重写shouldOverrideUrlLoading方法来进行url路由操作；为了数据安全，建议在app的WebView中只加载该app自有的主机链接；对于其他不能确定安全性的链接在交给系统中其他程序处理。</p>
<p>然后为WebView初始化一个WebViewClient实例：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> MyWebViewClient());</span><br></pre></td></tr></table></figure>
<h2 id="WebView历史导航">WebView历史导航</h2><p>如果WebView重新加载了其他的URL，那么它会自动累加保存一个页面历史记录。可以通过 goBack() 和 goForward() 方法来进行历史导航。<br>如下代码，在activity中重写onKeyDown方法来处理返回按键的逻辑，其中 canGoBack() 用来判断是否还有历史页面可以返回，类似的还有 canGoForward()。如果用户按下返回键且存在可返回的历史页面，WebView回退到上一个历史页面。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Check if the key event was the Back button and if there's history</span></span><br><span class="line">    <span class="keyword">if</span> ((keyCode == KeyEvent.KEYCODE_BACK) &amp;&amp; myWebView.canGoBack()) &#123;</span><br><span class="line">        myWebView.goBack();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If it wasn't the Back key or there's no web page history, bubble up to the default</span></span><br><span class="line">    <span class="comment">// system behavior (probably exit the activity)</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">onKeyDown</span><span class="params">(keyCode, event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料">参考资料</h2><ul>
<li><a href="http://mthli.github.io/Android-WebView-JavaScript" target="_blank" rel="external">Android WebView 与 JavaScript 交互</a></li>
<li><a href="https://developer.android.com/intl/zh-cn/guide/webapps/webview.html" target="_blank" rel="external">Building Web Apps in WebView</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/01/Android_Debug_Bridge/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://hellopony.cn">PONY WEI</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>